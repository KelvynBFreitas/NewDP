<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ajuste para Email PJ</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />

    <style>
        /* --- TEMA CIANO & AURORA --- */
        :root {
            --cor-fundo-gradiente-1: #10161d;
            --cor-fundo-gradiente-2: #090e13;
            --cor-card-fundo: rgba(255, 255, 255, 0.15);
            --cor-card-fundo-hover: rgba(255, 255, 255, 0.25);
            --cor-card-borda: rgba(255, 255, 255, 0.25);
            --cor-texto-claro: #c2cbd6;
            --cor-texto-branco: #e0e6ec;
            --cor-destaque-primaria: #00bcd4;
            --cor-destaque-secundaria: #0087a3;
            --cor-shadow-leve: rgba(0, 0, 0, 0.2);
            --cor-shadow-media: rgba(0, 0, 0, 0.4);
            --cor-shadow-intensa: rgba(0, 0, 0, 0.6);
            --cor-sucesso: #198754;
            --cor-sucesso-fundo: rgba(25, 135, 84, 0.2);
            --cor-dataPag: #f3f3f3;
            --cor-perigo: #dc3545;
            --cor-perigo-claro: #ffbaba;
        }

        body {
            background: var(--cor-fundo-gradiente-2);
            min-height: 100vh;
            font-family: "Inter", Arial, sans-serif;
            color: var(--cor-texto-claro);
            overflow-x: hidden;
            padding-top: 80px;
            padding-bottom: 50px;
        }

        /* --- FUNDO AURORA --- */
        .aurora-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -2;
            overflow: hidden;
            filter: blur(90px);
            opacity: 0.25;
        }

        .aurora-blob {
            position: absolute;
            width: 60vw;
            height: 60vw;
            min-width: 500px;
            min-height: 500px;
            background-color: var(--cor-blob);
            border-radius: 50%;
            animation: aurora-anim 30s cubic-bezier(0.45, 0.05, 0.55, 0.95) infinite;
        }

        .aurora-blob:nth-child(1) {
            top: -30vh;
            left: -15vw;
            animation-delay: 0s;
            animation-duration: 32s;
        }

        .aurora-blob:nth-child(2) {
            top: 10vh;
            right: -20vw;
            animation-delay: -8s;
            animation-duration: 30s;
        }

        .aurora-blob:nth-child(3) {
            bottom: -25vh;
            left: 20vw;
            animation-delay: -16s;
            animation-duration: 28s;
        }

        .aurora-blob:nth-child(4) {
            bottom: 0vh;
            right: 30vw;
            animation-delay: -24s;
            animation-duration: 34s;
        }

        @keyframes aurora-anim {
            0% {
                transform: translate(0, 0) scale(1) rotate(0deg);
            }

            25% {
                transform: translate(40vw, 30vh) scale(1.2) rotate(30deg);
            }

            50% {
                transform: translate(10vw, -20vh) scale(0.8) rotate(60deg);
            }

            75% {
                transform: translate(-30vw, 20vh) scale(1.1) rotate(90deg);
            }

            100% {
                transform: translate(0, 0) scale(1) rotate(0deg);
            }
        }

        /* --- Navbar --- */
        .navbar-custom {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 30px var(--cor-shadow-leve);
            padding: 0.8rem 1.5rem;
            z-index: 1040;
        }

        .navbar-custom .navbar-brand {
            color: var(--cor-texto-branco);
            font-weight: 700;
            font-size: 1.3rem;
            text-shadow: 0 0 5px rgba(0, 188, 212, 0.2);
        }

        .navbar-custom .nav-link {
            color: var(--cor-texto-claro);
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }

        .navbar-custom .nav-link:hover,
        .navbar-custom .nav-link.active {
            color: var(--cor-texto-branco);
            background-color: rgba(255, 255, 255, 0.05);
            text-shadow: 0 0 3px rgba(0, 188, 212, 0.2);
        }

        .navbar-toggler {
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(255, 255, 255, 0.7)' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }

        .dropdown-menu {
            background: rgba(18, 28, 38, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid var(--cor-card-borda);
            box-shadow: 0 15px 40px var(--cor-shadow-media);
            border-radius: 12px;
        }

        .dropdown-item {
            color: var(--cor-texto-claro) !important;
            font-weight: 500;
        }

        .dropdown-item:hover {
            background-color: rgba(0, 188, 212, 0.15);
            color: var(--cor-destaque-primaria) !important;
        }

        .dropdown-item-text {
            color: var(--cor-texto-branco) !important;
            font-weight: 600;
        }

        .dropdown-divider {
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* --- Dashboard --- */
        .dashboard-container {
            width: 90%;
            margin: 0 auto;
            padding: 35px 30px;
            background: var(--cor-card-fundo);
            backdrop-filter: blur(12px);
            border: 1px solid var(--cor-card-borda);
            border-radius: 10px;
            box-shadow: 0 15px 40px var(--cor-shadow-media);
            position: relative;
            overflow: hidden;
            min-height: 400px;
        }

        .dashboard-container::before {
            content: "";
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--cor-destaque-primaria) 0%, #007bff 25%, var(--cor-destaque-primaria) 50%, #007bff 75%, var(--cor-destaque-primaria) 100%);
            background-size: 200% 200%;
            border-radius: 10px;
            z-index: -1;
            animation: gradient-border 10s ease infinite;
            opacity: 0.5;
        }

        @keyframes gradient-border {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .dashboard-container h3 {
            color: var(--cor-texto-branco);
            font-weight: 400;
            text-shadow: 0 0 10px rgba(0, 188, 212, 0.4);
            margin-bottom: 0.5rem !important;
        }

        .dashboard-container p {
            color: var(--cor-texto-claro);
            font-size: 1.05rem;
            margin-bottom: 1rem !important;
        }

        /* --- Stepper --- */
        .stepper-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .stepper-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex-grow: 1;
            flex-basis: 0;
        }

        .step-counter {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #333;
            color: #888;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .step-name {
            margin-top: 8px;
            color: #888;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .stepper-line {
            flex-grow: 1;
            height: 3px;
            background-color: #333;
            margin: 0 10px;
            position: relative;
            transition: all 0.3s ease;
        }

        .stepper-line::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            background-color: var(--cor-sucesso);
            transition: width 0.5s ease-out;
        }

        .stepper-item.active .step-counter {
            background-color: var(--cor-destaque-primaria);
            color: white;
            transform: scale(1.15);
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.5);
        }

        .stepper-item.active .step-name {
            color: var(--cor-destaque-primaria);
            font-weight: bold;
        }

        .stepper-item.completed .step-counter {
            background-color: var(--cor-sucesso);
            color: white;
        }

        .stepper-item.completed .step-name {
            color: var(--cor-texto-claro);
        }

        .stepper-line.completed::before {
            width: 100%;
        }

        /* --- Tabela e Checkbox Bonito --- */
        .table-container-custom {
            background: var(--cor-card-fundo);
            backdrop-filter: blur(8px);
            border: 1px solid var(--cor-card-borda);
            border-radius: 15px;
            padding: 0;
            box-shadow: 0 5px 20px var(--cor-shadow-leve);
            overflow: hidden;
        }

        .table-custom {
            background-color: transparent;
            color: var(--cor-texto-claro);
            margin-bottom: 0;
        }

        .table-custom th {
            color: var(--cor-texto-branco);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85rem;
            border-color: var(--cor-card-borda) !important;
            background-color: rgba(255, 255, 255, 0.05);
        }

        .table-custom td {
            border-color: var(--cor-card-borda) !important;
            vertical-align: middle;
            font-size: 0.85rem;
        }

        .table-custom tbody tr:hover {
            background-color: var(--cor-card-fundo-hover);
            color: var(--cor-texto-branco);
        }

        /* üü¢ Visual para Item Enviado */
        .tr-enviado {
            background-color: rgba(25, 135, 84, 0.15) !important;
            /* Fundo esverdeado */
            opacity: 0.75;
            /* Um pouco mais apagado */
        }

        .tr-enviado:hover {
            opacity: 1;
            background-color: rgba(25, 135, 84, 0.25) !important;
        }

        /* üü¢ Checkbox Bonito */
        .custom-checkbox {
            width: 1.3em;
            height: 1.3em;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--cor-card-borda);
            border-radius: 6px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            display: grid;
            place-content: center;
            transition: all 0.2s ease;
        }

        .custom-checkbox::before {
            content: "";
            width: 0.75em;
            height: 0.75em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em var(--cor-destaque-primaria);
            background-color: var(--cor-destaque-primaria);
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }

        .custom-checkbox:checked::before {
            transform: scale(1);
        }

        .custom-checkbox:checked {
            border-color: var(--cor-destaque-primaria);
            background-color: rgba(0, 188, 212, 0.1);
        }

        .custom-checkbox:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.3);
        }

        /* üü¢ Alerta de Sele√ß√£o Global */
        .selection-alert {
            background-color: rgba(255, 193, 7, 0.15);
            border: 1px solid rgba(255, 193, 7, 0.4);
            color: #ffda6a;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: center;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .selection-alert:hover {
            background-color: rgba(255, 193, 7, 0.25);
            text-decoration: underline;
        }

        .selection-alert strong {
            color: #fff;
        }

        /* --- Form Elements --- */
        .form-control-custom,
        .form-select-custom {
            background: var(--cor-card-fundo);
            border: 1px solid var(--cor-card-borda);
            color: var(--cor-texto-branco);
            border-radius: 0.375rem;
            transition: all 0.3s ease;
        }

        .form-control-custom:focus,
        .form-select-custom:focus {
            background: var(--cor-card-fundo);
            border-color: var(--cor-destaque-primaria);
            color: var(--cor-texto-branco);
            box-shadow: 0 0 0 0.25rem rgba(0, 188, 212, 0.25);
        }

        .form-control-custom::placeholder {
            color: var(--cor-texto-claro);
            opacity: 0.7;
        }

        .form-select-custom option {
            background-color: #090e13;
            color: var(--cor-texto-branco);
        }

        .form-control-custom:disabled,
        .form-control-custom[readonly] {
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--cor-texto-claro);
            opacity: 0.7;
        }

        .form-control-custom.is-invalid,
        .form-select-custom.is-invalid {
            border-color: var(--cor-perigo) !important;
            box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
        }

        .text-danger {
            color: var(--cor-perigo-claro) !important;
            font-size: 0.875em;
        }

        .input-group-glass .input-group-text {
            background: var(--cor-card-fundo);
            border: 1px solid var(--cor-card-borda);
            color: var(--cor-destaque-primaria);
            border-left: 0;
        }

        /* --- Modal --- */
        .modal-content-custom {
            background: #0e2231b0;
            backdrop-filter: blur(15px);
            border: 1px solid var(--cor-card-borda);
            color: var(--cor-texto-claro);
        }

        .modal-content-custom .modal-header {
            border-bottom: 1px solid var(--cor-card-borda);
        }

        .modal-content-custom .form-control-custom {
            background: rgba(0, 0, 0, 0.2);
        }

        /* --- Loading --- */
        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--cor-fundo-gradiente-2);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--cor-card-borda);
            border-top-color: var(--cor-destaque-primaria);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        /* --- SweetAlert2 Theme --- */
        .swal2-popup {
            background: var(--cor-fundo-gradiente-1) !important;
            color: var(--cor-texto-branco) !important;
            border: 1px solid var(--cor-card-borda) !important;
            border-radius: 15px !important;
        }

        .swal2-title {
            color: var(--cor-texto-branco) !important;
            font-size: 1rem !important;
        }

        .swal2-html-container {
            color: var(--cor-texto-claro) !important;
        }

        .swal2-timer-progress-bar {
            background-color: var(--cor-destaque-primaria) !important;
        }

        .swal2-toast {
            border: 1px solid var(--cor-card-borda) !important;
            box-shadow: 0 8px 25px var(--cor-shadow-intensa) !important;
        }
    </style>
</head>

<body>

    <div class="aurora-container">
        <div class="aurora-blob" style="--cor-blob: #0d47a1"></div>
        <div class="aurora-blob" style="--cor-blob: #4a148c"></div>
        <div class="aurora-blob" style="--cor-blob: #00bcd4"></div>
        <div class="aurora-blob" style="--cor-blob: #ad1457"></div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-custom fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="bi bi-person-vcard me-2"></i>{{empresa}}</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    {% for item in menus %} {% if item.submenu %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            {{ item.title }}
                        </a>
                        <ul class="dropdown-menu">
                            {% for sub in item.submenu %}
                            <li><a class="dropdown-item" href="{{ sub.url }}">{{ sub.title }}</a></li>
                            {% endfor %}
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item"><a class="nav-link" href="{{ item.url }}">{{ item.title }}</a></li>
                    {% endif %} {% endfor %}
                </ul>
                <ul class="navbar-nav mb-2 mb-lg-0 align-items-center">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            <i class="bi bi-person-circle me-1"></i> Perfil
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><span class="dropdown-item-text"><strong>{{ username }}</strong></span></li>
                            <li><span class="dropdown-item-text text-muted small">{{ user_username }}</span></li>
                            <li>
                                <hr class="dropdown-divider" />
                            </li>
                            <li><a class="dropdown-item" href="/logout"><i class="bi bi-box-arrow-right me-2"></i>
                                    Sair</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    {% raw %}
    <div id="app" class="dashboard-container mx-auto">

        <div id="loading-overlay" v-if="isLoading">
            <div class="spinner"></div>
        </div>

        <div v-else>
            <div class="stepper-wrapper">
                <div class="stepper-item" :class="{ 'active': currentStep === 1, 'completed': currentStep > 1 }">
                    <div class="step-counter"><i v-if="currentStep > 1" class="bi bi-check-lg"></i><span v-else>1</span>
                    </div>
                    <div class="step-name">Verifica√ß√£o</div>
                </div>
                <div class="stepper-line" :class="{ 'completed': currentStep > 1 }"></div>
                <div class="stepper-item" :class="{ 'active': currentStep === 2, 'completed': currentStep > 2 }">
                    <div class="step-counter"><i v-if="currentStep > 2" class="bi bi-check-lg"></i><span v-else>2</span>
                    </div>
                    <div class="step-name">Datas de Corte</div>
                </div>
                <div class="stepper-line" :class="{ 'completed': currentStep > 2 }"></div>
                <div class="stepper-item" :class="{ 'active': currentStep === 3 }">
                    <div class="step-counter"><i
                            v-if="currentStep === 3 && (selecaoFinal.length > 0 || selecionarTudoGlobal)"
                            class="bi bi-send"></i><span v-else>3</span></div>
                    <div class="step-name">Envio de E-mail</div>
                </div>
            </div>

            <Transition name="page-fade" mode="out-in">

                <div v-if="currentStep === 1" key="step1">
                    <div class="d-flex justify-content-between align-items-start mb-3 flex-wrap gap-2">
                        <div>
                            <h3>Etapa 1: Verifica√ß√£o</h3>
                            <p>Confira os dados da fonte principal e fa√ßa os ajustes necess√°rios.</p>
                        </div>
                        <div class="input-group input-group-glass" style="max-width: 410px;">
                            <select v-model="filtroStatus" class="form-select form-select-custom"
                                style="max-width: 165px;">
                                <option value="">Todos</option>
                                <option value="1">üü° Pendentes</option>
                                <option value="0">üü¢ Ajustados</option>
                            </select>
                            <input type="text" v-model="search1" class="form-control form-control-custom"
                                placeholder="Pesquisar na Etapa 1...">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                        </div>
                    </div>

                    <div class="table-container-custom">
                        <div class="table-responsive">
                            <table class="table table-custom table-striped align-middle">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>CPF</th>
                                        <th>Nome</th>
                                        <th>Cidade</th>
                                        <th>Centro de Custo</th>
                                        <th class="text-end">Planos</th>
                                        <th class="text-end">Ressarc.</th>
                                        <th class="text-end">VR</th>
                                        <th class="text-end">Outros</th>
                                        <th>A√ß√£o</th>
                                        <th class="text-end">Total</th>
                                        <th>Edit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-if="isLoadingEtapa1">
                                        <td colspan="12" class="text-center p-5">
                                            <div class="spinner-border text-info" role="status"></div>
                                        </td>
                                    </tr>
                                    <tr v-else v-for="item in paginatedEtapa1" :key="item.cpf">
                                        <td>
                                            <span v-if="item.status === 0" style="color: green;">üü¢</span>
                                            <span v-else-if="item.status === 1" style="color: gold;">üü°</span>
                                            <span v-else>‚ùì</span>
                                        </td>
                                        <td>{{ item.cpf }}</td>
                                        <td>{{ item.nome }}</td>
                                        <td>{{ item.cidade }}</td>
                                        <td>{{ item.centro }}</td>
                                        <td class="text-end">{{ formatCurrency(item.planos) }}</td>
                                        <td class="text-end">{{ formatCurrency(item.ressarcimento) }}</td>
                                        <td class="text-end">{{ formatCurrency(item.vr) }}</td>
                                        <td class="text-end">{{ formatCurrency(item.outros) }}</td>
                                        <td>{{ item.acao_ }}</td>
                                        <td class="text-end">
                                            <span
                                                :style="{ color: item.resultado < 0 ? 'var(--cor-perigo-claro)' : 'var(--cor-sucesso)', fontWeight: 'bold' }">{{
                                                formatCurrency(item.resultado) }}</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-warning" @click="abrirModal(item, 1)"><i
                                                    class="bi bi-pencil-square"></i></button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2"
                        v-if="totalItems1 > 0">
                        <span style="color: var(--cor-texto-claro); font-size: 0.9rem;">P√°gina {{ etapa1Page }} de {{
                            totalPage1 }}. (Total: {{ totalItems1 }})</span>
                        <nav v-if="totalPage1 > 1">
                            <ul class="pagination pagination-sm mb-0 pagination-custom">
                                <li class="page-item" :class="{ disabled: etapa1Page === 1 }"><a class="page-link"
                                        href="#" @click.prevent="goToPage1(etapa1Page - 1)"><i
                                            class="bi bi-chevron-left"></i></a></li>
                                <li class="page-item" v-for="page in visiblePages1" :key="page"
                                    :class="{ active: page === etapa1Page, disabled: page === '...' }"><a
                                        class="page-link" href="#" @click.prevent="goToPage1(page)">{{ page }}</a></li>
                                <li class="page-item" :class="{ disabled: etapa1Page === totalPage1 }"><a
                                        class="page-link" href="#" @click.prevent="goToPage1(etapa1Page + 1)"><i
                                            class="bi bi-chevron-right"></i></a></li>
                            </ul>
                        </nav>
                    </div>

                    <button @click="currentStep = 2" class="btn btn-primary float-end mt-3">Pr√≥ximo</button>
                </div>

                <div v-if="currentStep === 2" key="step2">
                    <div class="text-center mb-4">
                        <h3>Etapa 2: Defini√ß√£o de Datas</h3>
                        <p>Informe as datas de corte e pagamento.</p>
                    </div>
                    <div class="row justify-content-center mt-5">
                        <div class="col-md-8 col-lg-6">
                            <div class="p-4"
                                style="background: rgba(255, 255, 255, 0.04); border: 1px solid var(--cor-card-borda); border-radius: 15px;">
                                <div class="mb-4">
                                    <label class="form-label text-white"><i class="bi bi-receipt me-2"></i>Data de
                                        Emiss√£o da Nota</label>
                                    <input type="date" v-model="dataEmissao" class="form-control form-control-custom"
                                        style="color-scheme: dark;">
                                </div>
                                <div>
                                    <label class="form-label text-white"><i class="bi bi-cash-coin me-2"></i>Data
                                        Prevista de Pagamento</label>
                                    <input type="date" v-model="dataPagamento" class="form-control form-control-custom"
                                        style="color-scheme: dark;">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-5">
                        <button @click="currentStep = 1" class="btn btn-secondary">Voltar</button>
                        <button @click="currentStep = 3" class="btn btn-primary"
                            :disabled="!dataEmissao || !dataPagamento">Pr√≥ximo <i
                                class="bi bi-chevron-right ms-1"></i></button>
                    </div>
                </div>

                <div v-if="currentStep === 3" key="step3">
                    <div class="d-flex justify-content-between align-items-start mb-3 flex-wrap gap-2">
                        <div>
                            <h3>Etapa 3: Envio de E-mail</h3>
                            <p>Selecione os itens para disparo. Utilize os filtros para segmentar.</p>
                        </div>
                        <div class="d-flex gap-2" style="max-width: 600px; flex-grow: 1; justify-content: flex-end;">



                            <select v-model="filtroAprovador" class="form-select form-select-custom">

                                <option value="">Todos Aprovadores</option>
                                <option v-for="aprov in listaAprovadores" :key="aprov" :value="aprov">

                                    {{ aprov }}

                                </option>

                            </select>

                            <div class="input-group input-group-glass" style="max-width: 300px;">
                                <input type="text" v-model="search3" class="form-control form-control-custom"
                                    placeholder="Pesquisar...">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                            </div>
                        </div>
                    </div>

                    <div v-if="mostrarAlertaSelecaoGlobal" class="selection-alert" @click="toggleSelectAllGlobal">
                        Todos os <strong>{{ paginatedEtapa3.length }}</strong> itens desta p√°gina est√£o selecionados.
                        <strong>Clique aqui para selecionar todos os {{ totalItems3 }} itens do banco de dados.</strong>
                    </div>
                    <div v-if="selecionarTudoGlobal" class="selection-alert"
                        style="background-color: rgba(13, 202, 240, 0.15); border-color: var(--cor-info); color: var(--cor-texto-branco); cursor: default;">
                        Todos os <strong>{{ totalItems3 }}</strong> itens do banco de dados est√£o selecionados.
                        <a href="#" @click.prevent="limparSelecao"
                            style="color: var(--cor-destaque-primaria); margin-left: 10px;">Limpar sele√ß√£o</a>
                    </div>

                    <div class="table-container-custom">
                        <div class="table-responsive">
                            <table class="table table-custom table-striped align-middle">
                                <thead>
                                    <tr>
                                        <th width="5%" class="text-center">
                                            <input type="checkbox" v-model="todosSelecionados" class="custom-checkbox">
                                        </th>
                                        <th>#</th>
                                        <th>CPF</th>
                                        <th>Nome</th>
                                        <th>Aprovador</th>
                                        <th>Cidade</th>
                                        <th class="text-end">Planos</th>
                                        <th class="text-end">Ressarc.</th>
                                        <th class="text-end">VR</th>
                                        <th class="text-end">Outros</th>
                                        <th>A√ß√£o</th>
                                        <th class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="item in paginatedEtapa3" :key="item.cpf"
                                        :class="{ 'tr-enviado': item.enviado }">
                                        <td class="text-center">
                                            <input type="checkbox" :value="item.cpf" v-model="selecaoFinal"
                                                :disabled="selecionarTudoGlobal" class="custom-checkbox">
                                        </td>

                                        <td>
                                            <span v-if="item.status === 0" title="Modificado">üü¢</span>
                                            <span v-else-if="item.status === 1" title="Pendente">üü°</span>
                                            <span v-else>‚ùì</span>
                                            <i v-if="item.status_envio === 1" class="bi bi-envelope-check-fill ms-1 text-success"
                                                title="J√° Enviado"></i>
                                        </td>

                                        <td>{{ item.cpf }}</td>
                                        <td>{{ item.nome }}</td>
                                        <td>
                                            <span class="badge"
                                                style="background-color: rgba(0, 188, 212, 0.15); color: var(--cor-destaque-primaria); border: 1px solid rgba(0, 188, 212, 0.3);">
                                                {{ item.aprovador || 'N/D' }}
                                            </span>
                                        </td>
                                        <td>{{ item.cidade }}</td>
                                        <td class="text-end">{{ formatCurrency(item.planos) }}</td>
                                        <td class="text-end">{{ formatCurrency(item.ressarcimento) }}</td>
                                        <td class="text-end">{{ formatCurrency(item.vr) }}</td>
                                        <td class="text-end">{{ formatCurrency(item.outros) }}</td>
                                        <td>{{ item.acao_ }}</td>
                                        <td class="text-end">
                                            <span
                                                :style="{ color: item.resultado < 0 ? 'var(--cor-perigo-claro)' : 'var(--cor-sucesso)', fontWeight: 'bold' }">{{
                                                formatCurrency(item.resultado) }}</span>
                                        </td>
                                    </tr>

                                    <tr v-if="filteredEtapa3.length === 0">
                                        <td :colspan="12" class="text-center p-4">
                                            <i class="bi bi-search me-2"></i> Nenhum item encontrado.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2"
                        v-if="totalItems3 > 0">
                        <span style="color: var(--cor-texto-claro); font-size: 0.9rem;">
                            P√°gina {{ etapa3Page }} de {{ totalPage3 }}. (Visualizando {{ paginatedEtapa3.length }} de
                            {{ totalItems3 }} itens)
                        </span>
                        <nav v-if="totalPage3 > 1">
                            <ul class="pagination pagination-sm mb-0 pagination-custom">
                                <li class="page-item" :class="{ disabled: etapa3Page === 1 }"><a class="page-link"
                                        href="#" @click.prevent="goToPage3(etapa3Page - 1)"><i
                                            class="bi bi-chevron-left"></i></a></li>
                                <li class="page-item" v-for="page in visiblePages3" :key="page"
                                    :class="{ active: page === etapa3Page, disabled: page === '...' }"><a
                                        class="page-link" href="#" @click.prevent="goToPage3(page)">{{ page }}</a></li>
                                <li class="page-item" :class="{ disabled: etapa3Page === totalPage3 }"><a
                                        class="page-link" href="#" @click.prevent="goToPage3(etapa3Page + 1)"><i
                                            class="bi bi-chevron-right"></i></a></li>
                            </ul>
                        </nav>
                    </div>

                    <div class="mt-3">
                        <button @click="currentStep = 2" class="btn btn-secondary">Voltar</button>
                        <button @click="enviarFinal" class="btn btn-success float-end"
                            :disabled="(selecaoFinal.length === 0 && !selecionarTudoGlobal) || isSending">
                            <span v-if="isSending" class="spinner-border spinner-border-sm me-1"></span>
                            <i v-else class="bi bi-send"></i>
                            {{ isSending ? 'Enviando...' : `Enviar (${selecionarTudoGlobal ? 'TODOS ' + totalItems3 :
                            selecaoFinal.length})` }}
                        </button>
                    </div>
                </div>

            </Transition>

            <teleport to="body">
                <div class="modal fade" id="modalEdicao" ref="modalEdicao" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content modal-content-custom">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Editar Item</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div v-if="etapaItemSelecionado === 1">
                                    <div class="row">
                                        <div class="col-md-6 mb-3"> <label class="form-label">CPF</label> <input
                                                type="text" :value="itemSelecionado.cpf"
                                                class="form-control form-control-custom" disabled> </div>
                                        <div class="col-md-6 mb-3"> <label class="form-label">Nome</label> <input
                                                type="text" :value="itemSelecionado.nome"
                                                class="form-control form-control-custom" disabled> </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3"> <label class="form-label">Planos</label> <input
                                                type="number" v-model.number="itemSelecionado.planos"
                                                class="form-control form-control-custom"> </div>
                                        <div class="col-md-6 mb-3"> <label class="form-label">Ressarcimento</label>
                                            <input type="number" v-model.number="itemSelecionado.ressarcimento"
                                                class="form-control form-control-custom"> </div>
                                        <div class="col-md-6 mb-3"> <label class="form-label">VR</label> <input
                                                type="number" v-model.number="itemSelecionado.vr"
                                                class="form-control form-control-custom"> </div>
                                        <div class="col-md-6 mb-3"> <label class="form-label">Outros</label> <input
                                                type="number" v-model.number="itemSelecionado.outros"
                                                class="form-control form-control-custom"> </div>
                                    </div>
                                    <hr style="border-color: var(--cor-card-borda);">
                                    <div class="row">
                                        <div class="col-md-6 mb-3"> <label class="form-label">A√ß√£o</label> <input
                                                type="text" :value="itemSelecionado.acao_"
                                                class="form-control form-control-custom" disabled> </div>
                                        <div class="col-md-6 mb-3"> <label class="form-label">Resultado</label> <input
                                                type="number" :value="itemSelecionado.resultado"
                                                class="form-control form-control-custom" disabled> </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Motivo</label>
                                            <select class="form-select form-select-custom"
                                                v-model="itemSelecionado.motivo"
                                                :class="{ 'is-invalid': outrosSemMotivo }">
                                                <option value="" selected>Sem motivo</option>
                                                <option value="Ferias">F√©rias</option>
                                                <option value="Retroativo">Retroativo</option>
                                                <option value="Outros">Outros</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12 mb-3">
                                            <label class="form-label">Justificativa</label>
                                            <textarea class="form-control form-control-custom" rows="3"
                                                v-model="itemSelecionado.justificativa"
                                                :class="{ 'is-invalid': motivoOutrosSemJustificativa }"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-secondary"
                                    data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" @click="salvarModal" class="btn btn-primary"
                                    :disabled="isModalSalvarDisabled">
                                    <span v-if="isSaving" class="spinner-border spinner-border-sm me-1"></span> {{
                                    isSaving ? 'Salvando...' : 'Salvar' }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </teleport>

        </div>
    </div> {% endraw %}

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const { createApp, ref, computed } = Vue

        createApp({
            data() {
                return {
                    isLoading: true, isLoadingEtapa1: false,
                    filtroStatus: '', currentStep: 1,
                    dataEmissao: '', dataPagamento: '',
                    totalItems3: 0, selecaoFinal: [],
                    listaAprovadores: [],
                    // Flag para selecionar TUDO do banco
                    selecionarTudoGlobal: false,

                    etapa3Page: 1, etapa3Limit: 10,
                    etapa1Data: [], etapa3Data: [],
                    search1: '', search3: '', filtroAprovador: '',
                    itemSelecionado: {}, etapaItemSelecionado: null, modalInstance: null,
                    isSaving: false, isSending: false,
                    etapa1Page: 1, etapa1Limit: 10, totalItems1: 0,
                }
            },

            watch: {
                search1() { this.etapa1Page = 1; this.fetchData('1'); },
                etapa1Page() { this.fetchData('1'); },
                filtroStatus() { this.etapa1Page = 1; this.fetchData('1'); },
                filtroAprovador() { 
                        this.etapa3Page = 1; 
                        this.limparSelecao(); 
                        this.fetchData('3'); // Adicionado para buscar no banco com o novo filtro
                    },                search3() { this.etapa3Page = 1; this.fetchData('3'); },
                etapa3Page() { this.fetchData('3'); },
                itemSelecionado: {
                    handler(newItem) {
                        if (this.etapaItemSelecionado === 1) {
                            const planos = Number(newItem.planos) || 0;
                            const vr = Number(newItem.vr) || 0;
                            const outros = Number(newItem.outros) || 0;
                            const ressarcimento = Number(newItem.ressarcimento) || 0;
                            const resultadoCalc = ressarcimento + vr - planos + outros;
                            this.itemSelecionado.resultado = parseFloat(resultadoCalc.toFixed(2));
                            this.itemSelecionado.acao_ = resultadoCalc < 0 ? 'Descontar na Nota >>>>>' : 'Adicionar na Nota >>>>>';
                        }
                    }, deep: true
                }
            },

            computed: {
                paginatedEtapa1() { return this.etapa1Data; },
                totalPage1() { return this.totalItems1 === 0 ? 1 : Math.ceil(this.totalItems1 / this.etapa1Limit); },
                visiblePages1() { return this.getVisiblePages(this.etapa1Page, this.totalPage1); },

                // Logica de Sele√ß√£o do Header
                todosSelecionados: {
                    get() {
                        if (this.selecionarTudoGlobal) return true; // Visualmente marcado se global estiver ativo
                        if (!this.paginatedEtapa3 || this.paginatedEtapa3.length === 0) return false;
                        return this.paginatedEtapa3.every(item => this.selecaoFinal.includes(item.cpf));
                    },
                    set(value) {
                        const cpfsPaginaAtual = this.paginatedEtapa3.map(item => item.cpf);
                        if (value) {
                            // Seleciona pagina atual
                            cpfsPaginaAtual.forEach(cpf => {
                                if (!this.selecaoFinal.includes(cpf)) this.selecaoFinal.push(cpf);
                            });
                        } else {
                            // Deseleciona e limpa global
                            this.selecionarTudoGlobal = false;
                            this.selecaoFinal = this.selecaoFinal.filter(cpf => !cpfsPaginaAtual.includes(cpf));
                        }
                    }
                },

                // Mostra alerta se todos da P√ÅGINA est√£o selecionados, mas N√ÉO todos do banco
                mostrarAlertaSelecaoGlobal() {
                    if (this.selecionarTudoGlobal) return false; // J√° selecionou tudo
                    if (this.totalItems3 <= this.etapa3Limit) return false; // S√≥ tem 1 p√°gina
                    if (!this.paginatedEtapa3 || this.paginatedEtapa3.length === 0) return false;

                    // Verifica se todos da p√°gina atual est√£o selecionados
                    const todosPagina = this.paginatedEtapa3.every(item => this.selecaoFinal.includes(item.cpf));
                    return todosPagina;
                },

                filteredEtapa3() {
                    let dados = this.etapa3Data || [];
                  
                    return dados;
                },
                paginatedEtapa3() { return this.filteredEtapa3; },
                totalPage3() { return !this.totalItems3 ? 1 : Math.ceil(this.totalItems3 / this.etapa3Limit); },
                visiblePages3() { return this.getVisiblePages(this.etapa3Page, this.totalPage3); },

                outrosSemMotivo() {
                    if (this.etapaItemSelecionado !== 1 || !this.itemSelecionado.hasOwnProperty('outros')) return false;
                    return (this.itemSelecionado.outros && Number(this.itemSelecionado.outros) !== 0) && (!this.itemSelecionado.motivo || this.itemSelecionado.motivo === "");
                },
                motivoOutrosSemJustificativa() {
                    if (this.etapaItemSelecionado !== 1 || !this.itemSelecionado.hasOwnProperty('motivo')) return false;
                    return (this.itemSelecionado.motivo === "Outros") && (!this.itemSelecionado.justificativa || this.itemSelecionado.justificativa.trim() === "");
                },
                isModalSalvarDisabled() { return this.isSaving || this.outrosSemMotivo || this.motivoOutrosSemJustificativa; },
            
            },

            methods: {
                showToast(type, title, message) {
                    const Toast = Swal.mixin({ toast: true, position: "top-end", showConfirmButton: false, timer: 3000, timerProgressBar: true, customClass: { popup: "swal2-toast" } });
                    let iconType = type === 'danger' ? 'error' : type;
                    Toast.fire({ icon: iconType, title: title, text: message });
                },

                fetchData(etapa) {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => { controller.abort(); if (etapa === '1') this.isLoadingEtapa1 = false; }, 15000);
                    if (etapa === '1') this.isLoadingEtapa1 = true;

                    let url = `/api/dados_etapa${etapa}`;
                    
                    if (etapa === '1') {
                        url += `?page=${this.etapa1Page}&limit=${this.etapa1Limit}&search=${encodeURIComponent(this.search1)}&status=${this.filtroStatus}`;
                    } 
                    else if (etapa === '3') {
                        url = '/api/etapa_final';
                        //Incluindo o filtroAprovador na requisi√ß√£o GET
                        url += `?page=${this.etapa3Page}&limit=${this.etapa3Limit}&search=${encodeURIComponent(this.search3)}&aprovador=${encodeURIComponent(this.filtroAprovador)}`;
                    }

                    return fetch(url, { signal: controller.signal })
                        .then(res => res.json())
                        .then(data => {
                            clearTimeout(timeoutId);
                            if (etapa === '1') {
                                this.etapa1Data = data.data || []; this.totalItems1 = data.total || 0;
                                this.isLoadingEtapa1 = false;
                            } else if (etapa === '3') {
                                this.etapa3Data = data.data || []; this.totalItems3 = data.total || 0;
                            }
                        })
                        .catch(err => {
                            clearTimeout(timeoutId);
                            if (etapa === '1') this.isLoadingEtapa1 = false;
                            this[`etapa${etapa}Data`] = [];
                        });
                },
                formatCurrency(value) { return Number(value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); },
                abrirModal(item, etapa) {
                    this.itemSelecionado = { ...item, motivo: item.motivo || '', justificativa: item.justificativa || '' };
                    this.etapaItemSelecionado = etapa;
                    if (this.modalInstance) this.modalInstance.show();
                },
                fetchAprovadores() {
                    fetch('/api/lista_aprovadores')
                        .then(res => res.json())
                        .then(data => {
                            this.listaAprovadores = data || [];
                        })
                        .catch(err => console.error("Erro ao buscar aprovadores:", err));
                },
                async salvarModal() {
                    this.isSaving = true;
                    const etapa = this.etapaItemSelecionado;
                    const item = this.itemSelecionado;
                    try {
                        const response = await fetch(`/api/item/${etapa === 1 ? item.cpf : item.id}?etapa=${etapa}`, {
                            method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(item)
                        });
                        if (response.ok) {
                            this.showToast('success', 'Sucesso!', `Alterado com sucesso.`);
                            this.modalInstance.hide();
                            if (etapa === 1) this.fetchData('1');
                        } else {
                            this.showToast('error', 'Erro', 'Falha ao salvar.');
                        }
                    } catch (e) { this.showToast('error', 'Erro', 'Erro de conex√£o.'); }
                    finally { this.isSaving = false; }
                },

                // üü¢ L√≥gica de Sele√ß√£o Global
                toggleSelectAllGlobal() {
                    this.selecionarTudoGlobal = true;
                    // Esvazia a sele√ß√£o manual para n√£o enviar IDs duplicados, pois o flag global manda tudo
                    this.selecaoFinal = [];
                },
                limparSelecao() {
                    this.selecaoFinal = [];
                    this.selecionarTudoGlobal = false;
                },

                async enviarFinal() {
                    // 1. Valida√ß√£o B√°sica
                    if (this.selecaoFinal.length === 0 && !this.selecionarTudoGlobal) {
                        this.showToast('info', 'Aten√ß√£o', 'Selecione pelo menos um item.');
                        return;
                    }

                    // Calcula quantidade visual para a mensagem
                    const qtdItens = this.selecionarTudoGlobal ? this.totalItems3 : this.selecaoFinal.length;

                    // 2. Confirma√ß√£o com SweetAlert2
                    const result = await Swal.fire({
                        title: 'Confirmar Envio',
                        html: `
                            <div class="text-start" style="font-size: 0.95rem;">
                                <p>Voc√™ est√° prestes a processar <b>${qtdItens}</b> colaboradores.</p>
                                <p>Verifique os seguintes pontos:</p>
                                <ul style="list-style: none; padding-left: 0;">
                                    <li>‚úÖ As datas de emiss√£o e pagamento est√£o corretas?</li>
                                    <li>‚úÖ Os valores e justificativas foram revisados?</li>
                                </ul>
                                <p class="mb-0">Deseja iniciar o disparo dos e-mails?</p>
                            </div>
                        `,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: 'var(--cor-destaque-primaria)',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: '<i class="bi bi-send me-2"></i>Sim, Enviar!',
                        cancelButtonText: 'Cancelar',
                        reverseButtons: true,
                        allowOutsideClick: false
                    });

                    if (!result.isConfirmed) return;

                    this.isSending = true;

                    // 3. Simula√ß√£o Visual de "Preparando Envio"
                    // Mostra um loading enquanto chama o backend
                    let timerInterval;
                    Swal.fire({
                        title: 'Processando...',
                        html: 'Registrando informa√ß√µes e iniciando fila de envio.<br><b>Aguarde...</b>',
                        timerProgressBar: false,
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    const payload = {
                        ids: this.selecaoFinal,
                        enviar_tudo: this.selecionarTudoGlobal,
                        filtros: {
                            search: this.search3,
                            aprovador: this.filtroAprovador
                        },
                        data_emissao: this.dataEmissao,
                        data_pagamento: this.dataPagamento
                    };

                    try {
                        const response = await fetch('/api/enviar_final', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const data = await response.json();
                            
                            // 4. Sucesso - Feedback Visual do processo ass√≠ncrono
                            // O backend j√° respondeu "OK", mas dizemos ao usu√°rio que o envio continua em background
                            Swal.fire({
                                icon: 'success',
                                title: 'Processo Iniciado!',
                                html: `
                                    <p>Os dados foram gravados com sucesso.</p>
                                    <p class="small text-muted">O envio dos e-mails para <b>${data.recebidos}</b> colaboradores continuar√° sendo processado em segundo plano pelo servidor.</p>
                                `,
                                confirmButtonText: 'Ok',
                                confirmButtonColor: 'var(--cor-sucesso)'
                            });

                            this.limparSelecao();
                            // Atualiza a lista para mostrar os √≠cones de "Enviado"
                            this.fetchData('3'); 
                            
                            // Opcional: Atualizar etapa 1 caso algo tenha voltado
                            this.fetchData('1');

                        } else {
                            const errData = await response.json();
                            Swal.fire({
                                icon: 'error',
                                title: 'Falha no Processamento',
                                text: errData.detail || 'Ocorreu um erro ao tentar enviar.',
                                confirmButtonColor: 'var(--cor-perigo)'
                            });
                        }
                    } catch (e) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Erro de Conex√£o',
                            text: 'N√£o foi poss√≠vel contatar o servidor.',
                            confirmButtonColor: 'var(--cor-perigo)'
                        });
                    } finally {
                        this.isSending = false;
                    }
                },

                goToPage1(page) { if (page >= 1 && page <= this.totalPage1 && page !== '...') this.etapa1Page = page; },
                goToPage3(page) { if (page >= 1 && page <= this.totalPage3 && page !== '...') this.etapa3Page = page; },
                getVisiblePages(curr, total) {
                    const max = 5; if (total <= max) return Array.from({ length: total }, (_, i) => i + 1);
                    let start = Math.max(1, curr - 2), end = Math.min(total, curr + 2);
                    if (curr <= 3) end = max; else if (curr >= total - 2) start = total - max + 1;
                    const p = []; if (start > 1) { p.push(1); if (start > 2) p.push('...'); }
                    for (let i = start; i <= end; i++) p.push(i);
                    if (end < total) { if (end < total - 1) p.push('...'); p.push(total); }
                    return p;
                }
            },
            mounted() {
                this.isLoading = false;
                this.$nextTick(() => { if (this.$refs.modalEdicao) this.modalInstance = new bootstrap.Modal(this.$refs.modalEdicao); });
                this.fetchData('1'); this.fetchData('3');
                 this.fetchAprovadores();
            }
        }).mount('#app')
    </script>
</body>

</html>